<div class="page-container">
  <app-header />

  <main class="main-content">
    <section class="series-detail-card">
      <header class="series-detail-header">
        <div class="header-top">
          <button type="button" class="back-button" (click)="goBack()" title="Zurück zur Übersicht">
            ← Zurück
          </button>
        </div>
        <div>
          <p class="subtitle">Messserie #{{ seriesId() }}</p>
          <h1>{{ seriesName() || 'Lade ...' }}</h1>
        </div>
        <p class="hint">
          Alle Messungen dieser Serie in tabellarischer Übersicht.
        </p>
      </header>

      @if (error(); as message) {
        <div class="status error">{{ message }}</div>
      }

      @if (loading()) {
        <div class="status info">Messungen werden geladen ...</div>
      }

      @if (!loading() && measurements().length > 0) {
        <div class="search-container">
          <div class="search-input-wrapper">
            <input
              type="text"
              class="search-input"
              placeholder="Suche nach ID, Werten, Feldern..."
              [value]="searchQuery()"
              (input)="onSearchChange($event)"
              />
            @if (searchQuery()) {
              <button type="button" class="clear-button" (click)="clearSearch()" title="Suche löschen">
                ✕
              </button>
            }
          </div>
          <div class="results-actions">
            <div class="results-meta">
              {{ filteredMeasurements().length }} von {{ measurements().length }} Messung{{ measurements().length !== 1 ? 'en' : '' }}
            </div>
            <div class="action-buttons">
              <button
                type="button"
                class="action-button"
                (click)="toggleColumnPicker()"
                title="Spalten ein-/ausblenden"
                >
                Spalten ({{ getVisibleColumns().length }})
              </button>
              <button
                type="button"
                class="action-button danger"
                [disabled]="!hasSelection() || deleteInProgress()"
                (click)="requestDeletion()"
                >
                {{ deleteInProgress() ? 'Löschen ...' : 'Löschen' }}
              </button>
            </div>
          </div>
        </div>

        @if (columnPickerVisible()) {
          <div class="column-picker">
            <div class="column-picker-header">
              <h3>Spalten auswählen</h3>
              <div class="column-picker-actions">
                <button type="button" class="picker-action-button" (click)="showAllColumns()">Alle anzeigen</button>
                <button type="button" class="picker-action-button" (click)="hideAllColumns()">Alle ausblenden</button>
              </div>
            </div>
            <div class="column-list">
              @for (column of getAllColumns(); track column) {
                <label class="column-item">
                  <input
                    type="checkbox"
                    [checked]="isColumnVisible(column)"
                    (change)="toggleColumnVisibility(column)"
                  />
                  <span>{{ column }}</span>
                </label>
              }
            </div>
          </div>
        }

        @if (filteredMeasurements().length > 0) {
          <div class="table-container">
            <table class="measurements-table">
              <thead>
                <tr>
                  <th class="select-column"></th>
                  @if (isBaseColumnVisible('Mess-ID')) {
                    <th>Mess-ID</th>
                  }
                  @if (isBaseColumnVisible('Erstellt von')) {
                    <th>Erstellt von</th>
                  }
                  @if (isBaseColumnVisible('Erstellt am')) {
                    <th>Erstellt am</th>
                  }
                  @for (column of getVisibleDataColumns(); track column) {
                    <th>{{ column }}</th>
                  }
                </tr>
              </thead>
              <tbody>
                @for (measurement of filteredMeasurements(); track trackById($index, measurement)) {
                  <tr (click)="goToMeasurement(measurement)" class="measurement-row">
                    <td class="select-column" (click)="$event.stopPropagation()">
                      <input
                        type="checkbox"
                        [checked]="isSelected(measurement.id)"
                        (click)="$event.stopPropagation()"
                        (change)="toggleSelection(measurement.id, $any($event.target).checked)"
                        />
                    </td>
                    @if (isBaseColumnVisible('Mess-ID')) {
                      <td class="cell-id">#{{ measurement.id }}</td>
                    }
                    @if (isBaseColumnVisible('Erstellt von')) {
                      <td class="cell-author">{{ measurement.createdByUsername }}</td>
                    }
                    @if (isBaseColumnVisible('Erstellt am')) {
                      <td class="cell-date">{{ measurement.createdAt | date: 'dd.MM.yyyy HH:mm' }}</td>
                    }
                    @for (column of getVisibleDataColumns(); track column) {
                      <td class="cell-value">
                        {{ getValueForColumn(measurement, column) }}
                      </td>
                    }
                  </tr>
                }
              </tbody>
            </table>
          </div>
        } @else {
          <div class="empty-state">
            <p class="empty-title">Keine Ergebnisse</p>
            <p class="empty-text">
              Keine Messungen gefunden für "{{ searchQuery() }}".
            </p>
          </div>
        }
      } @else {
        @if (!loading()) {
          <div class="empty-state">
            <p class="empty-title">Keine Messungen vorhanden</p>
            <p class="empty-text">
              Diese Messserie enthält noch keine Messungen.
            </p>
          </div>
        }
      }
    </section>
  </main>

  <app-footer />
</div>

@if (confirmVisible()) {
  <div class="modal-backdrop">
    <div class="modal-dialog">
      <h2>Aktion bestätigen</h2>
      <p>{{ confirmMessage() }}</p>
      <div class="modal-actions">
        <button type="button" class="modal-button" (click)="cancelDeletion()" [disabled]="deleteInProgress()">
          Abbrechen
        </button>
        <button
          type="button"
          class="modal-button danger"
          (click)="confirmDeletion()"
          [disabled]="deleteInProgress()"
          >
          {{ deleteInProgress() ? 'Löschen ...' : 'Löschen' }}
        </button>
      </div>
    </div>
  </div>
}

@if (successMessage()) {
  <div class="toast toast-success">
    {{ successMessage() }}
  </div>
}
