<div class="page-container">
  <app-header />

  <main class="main-content">
    <section class="create-measurement-card">
      <div class="intro">
        <h1>Messung erstellen</h1>
        <p>
          Wähle ein vorhandenes Template aus, um die passenden Eingabefelder automatisch zu laden.
          Das Speichern der Messung folgt, sobald das Backend-Endpunkt verfügbar ist.
        </p>
      </div>

      <div class="form-group">
        <label for="templateSelect">Template auswählen</label>
        <select id="templateSelect"
                class="form-control"
                [disabled]="loading()"
                #templateSelect
                (change)="onTemplateChange(templateSelect.value)">
          <option value="">Bitte wählen</option>
          <option *ngFor="let template of templates(); trackBy: trackById"
                  [value]="template.id"
                  [selected]="template.id === selectedTemplateId()">
            {{ template.name }}
          </option>
        </select>
      </div>

      @if (loading()) {
        <div class="status info">
          Templates werden geladen ...
        </div>
      }
      @if (error(); as message) {
        <div class="status error">
          {{ message }}
        </div>
      }

      @if (seriesLoading()) {
        <div class="status info">
          Messreihen werden geladen ...
        </div>
      }
      @if (seriesError(); as seriesMessage) {
        <div class="status error">
          {{ seriesMessage }}
        </div>
      }

      <div class="form-group series-select">
        <div class="label-row">
          <label for="seriesSelect">Messreihe auswählen</label>
          @if (!showSeriesForm()) {
            <button type="button" class="ghost-button" (click)="startCreateSeries()">
              Neue Messreihe erstellen
            </button>
          }
        </div>
        <select id="seriesSelect"
                class="form-control"
                [disabled]="seriesLoading() || measurementSeries().length === 0"
                #seriesSelect
                (change)="onSeriesChange(seriesSelect.value)">
          <option value="">Bitte wählen</option>
          <option *ngFor="let series of measurementSeries(); trackBy: trackById"
                  [value]="series.id"
                  [selected]="series.id === selectedSeriesId()">
            {{ series.name }}
          </option>
        </select>
      </div>

      @if (!seriesLoading() && measurementSeries().length === 0) {
        <div class="status hint">
          Es wurde noch keine Messreihe angelegt. Bitte zuerst eine Serie erstellen.
        </div>
      }

      @if (showSeriesForm()) {
        <div class="series-create-card">
          <h2>Neue Messreihe</h2>
          <form [formGroup]="seriesForm" (ngSubmit)="submitSeries()">
            <div class="form-group">
              <label for="seriesName">Name</label>
              <input id="seriesName" type="text" class="form-control" formControlName="name">
              @if (seriesForm.controls.name.invalid && seriesForm.controls.name.touched) {
                <small class="status error">Name ist erforderlich.</small>
              }
            </div>
            <div class="form-group">
              <label for="seriesDescription">Beschreibung</label>
              <textarea id="seriesDescription"
                        rows="3"
                        class="form-control"
                        formControlName="description"
                        placeholder="optional"></textarea>
            </div>
            <div class="series-create-actions">
              <button type="submit" class="btn btn-primary" [disabled]="createSeriesLoading()">
                Speichern
              </button>
              @if (measurementSeries().length > 0) {
                <button type="button"
                        class="btn btn-secondary"
                        (click)="cancelCreateSeries()"
                        [disabled]="createSeriesLoading()">
                  Abbrechen
                </button>
              }
            </div>
          </form>
          @if (createSeriesLoading()) {
            <p class="status info">Messreihe wird gespeichert ...</p>
          }
          @if (createSeriesError(); as createError) {
            <p class="status error">{{ createError }}</p>
          }
        </div>
      }

      @if (activeSchema(); as schema) {
        @if (measurementForm; as form) {
          <form [formGroup]="form"
                (ngSubmit)="onSubmit()">
            <div class="schema-sections">
              <section *ngFor="let section of schema.sections; trackBy: trackById"
                       class="schema-section">
                <h2>{{ section.title }}</h2>

                <article *ngFor="let card of section.cards; trackBy: trackById"
                         class="schema-card">
                  <header>
                    <h3>{{ card.title }}</h3>
                    @if (card.subtitle) {
                      <p>{{ card.subtitle }}</p>
                    }
                  </header>

                  <div class="schema-fields">
                    <div *ngFor="let field of card.fields; trackBy: trackById"
                         class="schema-field">
                      <label [attr.for]="getControlName(section.id, card.id, field.id, field.label)">
                        {{ field.label }}
                      </label>

                      @switch (field.type) {
                        @case ('multiline') {
                          <textarea rows="3"
                                    [id]="getControlName(section.id, card.id, field.id, field.label)"
                                    [formControlName]="getControlName(section.id, card.id, field.id, field.label)"></textarea>
                        }
                        @case ('table') {
                          <textarea rows="3"
                                    placeholder="Tabellendaten (CSV oder Markdown)"
                                    [id]="getControlName(section.id, card.id, field.id, field.label)"
                                    [formControlName]="getControlName(section.id, card.id, field.id, field.label)"></textarea>
                        }
                        @case ('number') {
                          <input type="number"
                                 [id]="getControlName(section.id, card.id, field.id, field.label)"
                                 [formControlName]="getControlName(section.id, card.id, field.id, field.label)" />
                        }
                        @case ('media') {
                          <input type="text"
                                 placeholder="Pfad oder Referenz zu Medien"
                                 [id]="getControlName(section.id, card.id, field.id, field.label)"
                                 [formControlName]="getControlName(section.id, card.id, field.id, field.label)" />
                        }
                        @default {
                          <input type="text"
                                 [id]="getControlName(section.id, card.id, field.id, field.label)"
                                 [formControlName]="getControlName(section.id, card.id, field.id, field.label)" />
                        }
                      }

                      @if (field.hint) {
                        <small>{{ field.hint }}</small>
                      }
                    </div>
                  </div>
                </article>
              </section>
            </div>

            <div class="actions">
              <button type="submit"
                      class="btn btn-primary"
                      [disabled]="!form.valid || submitting() || !selectedSeriesId()">
                Messung vorbereiten
              </button>
            </div>
          </form>
        } @else {
          <p class="status hint">
            Das ausgewählte Template enthält aktuell keine Felder.
          </p>
        }
      } @else {
        <p class="status hint">
          Wähle ein Template aus der Liste, um die Messfelder zu sehen.
        </p>
      }

      @if (submitError(); as submitMessage) {
        <div class="status error">
          {{ submitMessage }}
        </div>
      }

    </section>
  </main>

  <app-footer />
</div>

@if (toastMessage()) {
  <div class="toast toast-success">
    {{ toastMessage() }}
  </div>
}
