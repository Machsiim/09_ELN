<div class="measurement-preview">
  <div class="preview-sections">
    @for (section of sections; track section.name) {
      <article class="preview-section">
        <header class="preview-section-header">
          <h2>{{ section.name }}</h2>
        </header>
        <div class="preview-cards">
          @for (card of section.cards; track card.name) {
            <div class="preview-card">
              <header class="preview-card-header">
                <div>
                  <h3>{{ card.name }}</h3>
                  <small>{{ card.fields.length }} Feld{{ card.fields.length === 1 ? '' : 'er' }}</small>
                </div>
              </header>
              <ul class="preview-fields">
                @for (field of card.fields; track field.key) {
                  <li>
                    <div class="field-meta">
                      <span class="field-label">{{ field.key }}</span>
                      <span class="field-type">{{ isEditing ? 'Eingabe' : 'Wert' }}</span>
                    </div>
                    @if (isEditing) {
                      @if (isMediaField(section.name, field.rawKey, field.value)) {
                        @let editAttachments = getEditableMediaAttachments(section.name, field.rawKey) ?? [];
                        <div class="field-value media-value">
                          <div class="media-summary">
                            <strong>
                              {{ editAttachments.length === 1 ? editAttachments[0].name : editAttachments.length + ' Dateien' }}
                            </strong>
                            <small *ngIf="editAttachments.length === 1">
                              {{ editAttachments[0].size / 1024 | number: '1.0-0' }} KB
                            </small>
                          </div>
                          <div class="media-buttons">
                            <button
                              type="button"
                              class="media-toggle-button"
                              (click)="onToggleMediaPreview(section.name, field.rawKey)">
                              {{ isMediaExpanded(section.name, field.rawKey) ? 'Bilder verbergen' : 'Bilder anzeigen' }}
                            </button>
                            <button type="button" class="media-add-button" (click)="onOpenMediaDialog(section.name, field.rawKey)">
                              Hinzuf√ºgen
                            </button>
                          </div>
                        </div>
                      } @else {
                        <input
                          class="field-input"
                          type="text"
                          [value]="getEditableValue(section.name, field.rawKey)"
                          (input)="onUpdateFieldValue(section.name, field.rawKey, $any($event.target).value)"
                          [disabled]="saveInProgress"
                        />
                      }
                    } @else {
                      @if (getMediaAttachments(field.value); as attachments) {
                        <div class="field-value media-value">
                          <div class="media-summary">
                            <strong>
                              {{ attachments.length === 1 ? attachments[0].name : attachments.length + ' Dateien' }}
                            </strong>
                            <small *ngIf="attachments.length === 1">
                              {{ attachments[0].size / 1024 | number: '1.0-0' }} KB
                            </small>
                          </div>
                          <button
                            type="button"
                            class="media-toggle-button"
                            (click)="onToggleMediaPreview(section.name, field.rawKey)">
                            {{ isMediaExpanded(section.name, field.rawKey) ? 'Bilder verbergen' : 'Bilder anzeigen' }}
                          </button>
                        </div>
                      } @else {
                        <span class="field-value">{{ formatValue(field.value) }}</span>
                      }
                    }
                  </li>
                  @if (isMediaField(section.name, field.rawKey, field.value) && isMediaExpanded(section.name, field.rawKey)) {
                    @if (!isEditing && getMediaAttachments(field.value); as previewAttachments) {
                      <div class="media-preview-card">
                        @for (attachment of previewAttachments; track attachment.id) {
                          <figure class="media-thumb">
                            <img [src]="attachment.dataUrl" [alt]="attachment.name" />
                            <figcaption>{{ attachment.name }}</figcaption>
                          </figure>
                        }
                      </div>
                    } @else if (isEditing && getEditableMediaAttachments(section.name, field.rawKey); as editableAttachments) {
                      <div class="media-preview-card editable-preview">
                        @for (attachment of editableAttachments; track attachment.id) {
                          <figure class="media-thumb media-thumb-editable">
                            <img [src]="attachment.dataUrl" [alt]="attachment.name" />
                            <figcaption>{{ attachment.name }}</figcaption>
                            <button
                              type="button"
                              class="media-remove-button"
                              (click)="onRemoveAttachment(section.name, field.rawKey, attachment.id)"
                              title="Bild entfernen">
                              <mat-icon fontIcon="delete"></mat-icon>
                            </button>
                          </figure>
                        }
                      </div>
                    }
                  }
                }
              </ul>
            </div>
          }
        </div>
      </article>
    }
  </div>
</div>
