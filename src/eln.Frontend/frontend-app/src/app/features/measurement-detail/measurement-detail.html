<div class="page-container">
  <app-header />

  <main class="main-content">
    <section class="detail-card">
      <header class="detail-header">
        <div class="header-top">
          <button class="back-button" type="button" (click)="goBack()">
            ← Zurück
          </button>
          <button class="history-button" type="button" (click)="openHistory()" title="Änderungsverlauf anzeigen">
            Verlauf
          </button>
        </div>
        <div class="header-main">
          <div class="titles">
            <p class="eyebrow">Messung</p>
            <h1>#{{ measurement()?.id || '...' }}</h1>
          </div>
          @if (measurement(); as data) {
            <div class="header-meta">
              <div class="meta-info">
                <p class="meta">
                  Serie #{{ data.seriesId }} · Template: {{ data.templateName }}
                </p>
                <p class="meta">
                  Erstellt von {{ data.createdByUsername }} am {{ data.createdAt | date: 'dd.MM.yyyy HH:mm' }} Uhr
                </p>
                @if (data.updatedAt) {
                  <p class="meta updated">
                    Zuletzt geändert von {{ data.updatedByUsername || 'Unbekannt' }} am {{ data.updatedAt | date: 'dd.MM.yyyy HH:mm' }} Uhr
                  </p>
                }
              </div>
              <div class="action-buttons">
                @if (!isEditing()) {
                  <button class="action-button edit active" (click)="startEditing()">Bearbeiten</button>
                  <button class="action-button danger" (click)="confirmDelete()">Löschen</button>
                } @else {
                  <button class="action-button" (click)="cancelEditing()" [disabled]="saveInProgress()">Abbrechen</button>
                  <button class="action-button success" (click)="saveEdits()" [disabled]="saveInProgress()">
                    {{ saveInProgress() ? 'Speichern ...' : 'Speichern' }}
                  </button>
                }
              </div>
            </div>
          }
        </div>
      </header>

      @if (error(); as message) {
        <div class="status error">{{ message }}</div>
      }

      @if (loading()) {
        <div class="status info">Messung wird geladen ...</div>
      }

      @if (!loading() && measurement()) {
        <div class="measurement-preview">
          <div class="preview-sections">
            @for (section of getSections(isEditing() ? editableData() : null); track section.name) {
              <article class="preview-section">
                <header class="preview-section-header">
                  <h2>{{ section.name }}</h2>
                </header>
                <div class="preview-cards">
                  @for (card of section.cards; track card.name) {
                    <div class="preview-card">
                      <header class="preview-card-header">
                        <div>
                          <h3>{{ card.name }}</h3>
                          <small>{{ card.fields.length }} Feld{{ card.fields.length === 1 ? '' : 'er' }}</small>
                        </div>
                      </header>
                      <ul class="preview-fields">
                        @for (field of card.fields; track field.key) {
                          <li>
                            <div class="field-meta">
                              <span class="field-label">{{ field.key }}</span>
                              <span class="field-type">{{ isEditing() ? 'Eingabe' : 'Wert' }}</span>
                            </div>
                            @if (isEditing()) {
                              @if (isMediaField(section.name, field.rawKey, field.value)) {
                                @let editAttachments = getEditableMediaAttachments(section.name, field.rawKey) ?? [];
                                <div class="field-value media-value">
                                  <div class="media-summary">
                                    <strong>
                                      {{ editAttachments.length === 1 ? editAttachments[0].name : editAttachments.length + ' Dateien' }}
                                    </strong>
                                    <small *ngIf="editAttachments.length === 1">
                                      {{ editAttachments[0].size / 1024 | number: '1.0-0' }} KB
                                    </small>
                                  </div>
                                  <div class="media-buttons">
                                    <button
                                      type="button"
                                      class="media-toggle-button"
                                      (click)="toggleMediaPreview(section.name, field.rawKey)">
                                      {{ isMediaExpanded(section.name, field.rawKey) ? 'Bilder verbergen' : 'Bilder anzeigen' }}
                                    </button>
                                    <button type="button" class="media-add-button" (click)="openMediaDialog(section.name, field.rawKey)">
                                      Hinzufügen
                                    </button>
                                  </div>
                                </div>
                              } @else {
                                <input
                                  class="field-input"
                                  type="text"
                                  [value]="getEditableValue(section.name, field.rawKey)"
                                  (input)="updateFieldValue(section.name, field.rawKey, $any($event.target).value)"
                                  [disabled]="saveInProgress()"
                                />
                              }
                            } @else {
                              @if (getMediaAttachments(field.value); as attachments) {
                                <div class="field-value media-value">
                                  <div class="media-summary">
                                    <strong>
                                      {{ attachments.length === 1 ? attachments[0].name : attachments.length + ' Dateien' }}
                                    </strong>
                                    <small *ngIf="attachments.length === 1">
                                      {{ attachments[0].size / 1024 | number: '1.0-0' }} KB
                                    </small>
                                  </div>
                                  <button
                                    type="button"
                                    class="media-toggle-button"
                                    (click)="toggleMediaPreview(section.name, field.rawKey)">
                                    {{ isMediaExpanded(section.name, field.rawKey) ? 'Bilder verbergen' : 'Bilder anzeigen' }}
                                  </button>
                                </div>
                              } @else {
                                <span class="field-value">{{ formatValue(field.value) }}</span>
                              }
                            }
                          </li>
                          @if (isMediaField(section.name, field.rawKey, field.value) && isMediaExpanded(section.name, field.rawKey)) {
                            @if (!isEditing() && getMediaAttachments(field.value); as previewAttachments) {
                              <div class="media-preview-card">
                                @for (attachment of previewAttachments; track attachment.id) {
                                  <figure class="media-thumb">
                                    <img [src]="attachment.dataUrl" [alt]="attachment.name" />
                                    <figcaption>{{ attachment.name }}</figcaption>
                                  </figure>
                                }
                              </div>
                            } @else if (isEditing() && getEditableMediaAttachments(section.name, field.rawKey); as editableAttachments) {
                              <div class="media-preview-card editable-preview">
                                @for (attachment of editableAttachments; track attachment.id) {
                                  <figure class="media-thumb media-thumb-editable">
                                    <img [src]="attachment.dataUrl" [alt]="attachment.name" />
                                    <figcaption>{{ attachment.name }}</figcaption>
                                    <button
                                      type="button"
                                      class="media-remove-button"
                                      (click)="removeEditableAttachment(section.name, field.rawKey, attachment.id)"
                                      title="Bild entfernen">
                                      <mat-icon fontIcon="delete"></mat-icon>
                                    </button>
                                  </figure>
                                }
                              </div>
                            }
                          }
                        }
                      </ul>
                    </div>
                  }
                </div>
              </article>
            }
          </div>
        </div>
      }
    </section>
  </main>

  <app-footer />
</div>

@if (deleteConfirmVisible()) {
  <div class="modal-backdrop">
    <div class="modal-dialog">
      <h2>Aktion bestätigen</h2>
      <p>Soll die Messung #{{ measurement()?.id }} wirklich gelöscht werden? Diese Aktion kann nicht widerrufen werden.</p>
      <div class="modal-actions">
        <button class="modal-button" type="button" (click)="closeDeleteModal()" [disabled]="deleteInProgress()">
          Abbrechen
        </button>
        <button
          class="modal-button danger"
          type="button"
          (click)="deleteMeasurement()"
          [disabled]="deleteInProgress()"
        >
          {{ deleteInProgress() ? 'Löschen ...' : 'Löschen' }}
        </button>
      </div>
    </div>
  </div>
}

@if (cancelEditVisible()) {
  <div class="modal-backdrop">
    <div class="modal-dialog">
      <h2>Bearbeitung abbrechen?</h2>
      <p>Sind Sie sicher, die Bearbeitung abzubrechen? Änderungen werden verworfen.</p>
      <div class="modal-actions">
        <button class="modal-button" type="button" (click)="closeCancelModal()">
          Zurück
        </button>
        <button class="modal-button danger" type="button" (click)="confirmCancelEditing()">
          Verwerfen
        </button>
      </div>
    </div>
  </div>
}

@if (toastMessage()) {
  <div class="toast toast-success">
    {{ toastMessage() }}
  </div>
}

@if (historyVisible()) {
  <div class="modal-backdrop">
    <div class="history-dialog">
      <header class="history-header">
        <h2>Änderungsverlauf</h2>
        <button type="button" (click)="closeHistory()" class="close-button">×</button>
      </header>
      @if (historyLoading()) {
        <p class="history-status">Verlauf wird geladen ...</p>
      } @else {
        @if (historyError(); as historyMessage) {
          <p class="history-status error">{{ historyMessage }}</p>
        } @else if (historyEntries().length === 0) {
          <p class="history-status">Für diese Messung wurden keine Änderungen erfasst.</p>
        } @else {
          <div class="history-list">
            @for (entry of historyEntries(); track entry.id) {
              <article class="history-entry">
                <header>
                  <h3>{{ entry.changeType }}</h3>
                  <small>
                    {{ entry.changedByUsername }} · {{ entry.changedAt | date: 'dd.MM.yyyy HH:mm' }}
                  </small>
                  @if (entry.changeDescription) {
                    <p class="history-description">{{ entry.changeDescription }}</p>
                  }
                </header>
                @if (entry.changes.length === 0) {
                  <p class="history-nochange">Keine Feldänderungen.</p>
                } @else {
                  <ul>
                    @for (change of entry.changes; track change.section + change.field) {
                      <li>
                        <strong>{{ change.section }} – {{ change.field }}:</strong>
                        <div class="change-value old" *ngIf="change.oldValue">
                          <strong>Alt:</strong>
                          {{ isMediaChange(change.field, change.oldValue) ? formatMediaSummary(change.oldValue) : change.oldValue }}
                        </div>
                        <div class="change-value new" *ngIf="change.newValue">
                          <strong>Neu:</strong>
                          {{ isMediaChange(change.field, change.newValue) ? formatMediaSummary(change.newValue) : change.newValue }}
                        </div>
                      </li>
                    }
                  </ul>
                }
              </article>
            }
          </div>
        }
      }
    </div>
  </div>
}

@if (mediaDialogOpen()) {
  <div class="modal-backdrop">
    <div class="media-dialog">
      <h3>Neue Bilder hinzufügen</h3>
      <app-media-upload-field
        [showLabel]="false"
        [ngModel]="pendingMediaAttachments()"
        (ngModelChange)="onDialogAttachmentsChange($event)">
      </app-media-upload-field>
      <div class="media-dialog-actions">
        <button type="button" class="media-add-button" (click)="saveDialogAttachments()">Speichern</button>
        <button type="button" class="media-remove-button" (click)="closeMediaDialog()">Abbrechen</button>
      </div>
    </div>
  </div>
}
