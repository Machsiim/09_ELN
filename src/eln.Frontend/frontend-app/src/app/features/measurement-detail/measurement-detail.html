<div class="page-container">
  <app-header />

  <main class="main-content">
    <section class="detail-card">
      <app-measurement-detail-header
        [measurement]="measurement()"
        [isEditing]="isEditing()"
        [saveInProgress]="saveInProgress()"
        [isSeriesLocked]="isSeriesLocked()"
        [isStaff]="isStaff"
        (back)="goBack()"
        (openHistory)="openHistory()"
        (startEditing)="startEditing()"
        (cancelEditing)="cancelEditing()"
        (saveEdits)="saveEdits()"
        (confirmDelete)="confirmDelete()">
      </app-measurement-detail-header>

      @if (error(); as message) {
      <div class="status error">{{ message }}</div>
      }

      @if (loading()) {
      <div class="status info">Messung wird geladen ...</div>
      }

      @if (!loading() && measurement()) {
        <app-measurement-detail-sections
          [sections]="getSections(isEditing() ? editableData() : null)"
          [isEditing]="isEditing()"
          [saveInProgress]="saveInProgress()"
          [formatValue]="formatValue.bind(this)"
          [formatMediaSummary]="formatMediaSummary.bind(this)"
          [isMediaField]="isMediaField.bind(this)"
        [getMediaAttachments]="getMediaAttachments.bind(this)"
        [getEditableMediaAttachments]="getEditableMediaAttachments.bind(this)"
          [isMediaExpanded]="isMediaExpanded.bind(this)"
          [getEditableValue]="getEditableValue.bind(this)"
        (toggleMediaPreview)="toggleMediaPreview($event.section, $event.field)"
        (openMediaDialog)="openMediaDialog($event.section, $event.field)"
        (updateFieldValue)="updateFieldValue($event.section, $event.field, $event.value)"
        (removeEditableAttachment)="removeEditableAttachment($event.section, $event.field, $event.attachmentId)">
      </app-measurement-detail-sections>

      <app-measurement-image-gallery [measurementId]="measurement()!.id" [readOnly]="!canEditImages()"
        [isEditing]="isEditing()" (openAddDialog)="openGalleryDialog()">
      </app-measurement-image-gallery>
      }
    </section>
  </main>

  <app-footer />
</div>

@if (deleteConfirmVisible()) {
<div class="modal-backdrop">
  <div class="modal-dialog">
    <h2>Aktion bestätigen</h2>
      <p>Soll die Messung #{{ measurement()?.id }} wirklich gelöscht werden? Diese Aktion kann nicht widerrufen werden.</p>
    <div class="modal-actions">
      <button class="modal-button" type="button" (click)="closeDeleteModal()" [disabled]="deleteInProgress()">
        Abbrechen
      </button>
        <button
          class="modal-button danger"
          type="button"
          (click)="deleteMeasurement()"
          [disabled]="deleteInProgress()"
        >
        {{ deleteInProgress() ? 'Löschen ...' : 'Löschen' }}
      </button>
    </div>
  </div>
</div>
}

@if (cancelEditVisible()) {
<div class="modal-backdrop">
  <div class="modal-dialog">
    <h2>Bearbeitung abbrechen?</h2>
    <p>Sind Sie sicher, die Bearbeitung abzubrechen? Änderungen werden verworfen.</p>
    <div class="modal-actions">
      <button class="modal-button" type="button" (click)="closeCancelModal()">
        Zurück
      </button>
      <button class="modal-button danger" type="button" (click)="confirmCancelEditing()">
        Verwerfen
      </button>
    </div>
  </div>
</div>
}

@if (toastMessage()) {
<div class="toast toast-success">
  {{ toastMessage() }}
</div>
}

@if (historyVisible()) {
  <app-measurement-history-dialog
    [loading]="historyLoading()"
    [error]="historyError()"
    [entries]="historyEntries()"
    [isMediaChange]="isMediaChange.bind(this)"
    [formatMediaSummary]="formatMediaSummary.bind(this)"
  (close)="closeHistory()">
</app-measurement-history-dialog>
}

@if (mediaDialogOpen()) {
  <app-measurement-media-dialog
    [attachments]="pendingMediaAttachments()"
    (attachmentsChange)="onDialogAttachmentsChange($event)"
    (save)="saveDialogAttachments()"
    (close)="closeMediaDialog()">
</app-measurement-media-dialog>
}

@if (galleryDialogOpen()) {
<app-measurement-media-dialog [attachments]="pendingMediaAttachments()"
  (attachmentsChange)="onDialogAttachmentsChange($event)" (save)="saveGalleryAttachments()"
  (close)="closeGalleryDialog()">
</app-measurement-media-dialog>
}