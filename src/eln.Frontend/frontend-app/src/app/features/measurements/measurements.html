<div class="page-container">
  <app-header />

  <main class="main-content">
    <section class="measurements-card">
      <header class="measurements-header">
        <div>
          <p class="subtitle">Messungen</p>
          <h1>Alle Messungen</h1>
        </div>
        <p class="hint">
          Durchsuche alle Messungen nach Seriennamen, Templates oder Autor*innen.
        </p>
      </header>

      <form class="toolbar" (ngSubmit)="onSearch()">
        <div class="search-wrapper">
          <span class="search-icon">ğŸ”</span>
          <input type="text"
                 placeholder="Suche ..."
                 autocomplete="off"
                 [formControl]="searchControl"
                 [disabled]="loading()" />
        </div>
        <div class="toolbar-buttons">
          <button type="submit"
                  class="icon-button"
                  title="Suche starten"
                  [disabled]="loading()">
            ğŸ”
          </button>
          <button type="button"
                  class="icon-button"
                  title="Filter anzeigen"
                  (click)="toggleFilterPanel()">
            âš™ï¸
          </button>
          <button type="button"
                  class="icon-button danger"
                  title="Filter zurÃ¼cksetzen"
                  (click)="resetSearch()"
                  [disabled]="!canResetSearch() || loading()">
            âœ•
          </button>
        </div>
      </form>

      @if (filterPanelOpen()) {
        <div class="filter-panel" [formGroup]="filterForm">
          <div class="form-group">
            <label for="seriesFilter">Serien-ID</label>
            <input id="seriesFilter" type="number" formControlName="seriesId">
          </div>
          <div class="form-group">
            <label for="dateFrom">Datum von</label>
            <input id="dateFrom" type="date" formControlName="dateFrom">
          </div>
          <div class="form-group">
            <label for="dateTo">Datum bis</label>
            <input id="dateTo" type="date" formControlName="dateTo">
          </div>
          <div class="filter-actions">
            <button type="button"
                    class="btn btn-primary"
                    (click)="applyFilters()"
                    [disabled]="loading()">
              Filter anwenden
            </button>
            <button type="button"
                    class="btn btn-secondary"
                    (click)="resetFilters()"
                    [disabled]="!hasActiveFilters()">
              ZurÃ¼cksetzen
            </button>
          </div>
        </div>
      }

      @if (error(); as message) {
        <div class="status error">{{ message }}</div>
      }

      @if (success(); as successMessage) {
        <div class="status success">{{ successMessage }}</div>
      }

      @if (loading()) {
        <div class="status info">Messungen werden geladen ...</div>
      }

      @if (!loading() && groupedMeasurements().length > 0) {
        <div class="results-meta">
          {{ groupedMeasurements().length }} Messserien
          @if (hasActiveQuery()) {
            <span>Â· Suchbegriff: â€{{ lastSearchTerm() }}â€œ</span>
          }
        </div>
        <div class="measurements-list">
          <article *ngFor="let group of groupedMeasurements(); trackBy: trackById"
                   class="measurement-row">
            <div class="measurement-row-header">
              <div>
                <p class="measurement-date">
                  Letzte Messung:
                  {{ group.latestCreatedAt | date: 'dd.MM.yyyy - HH:mm' }}
                </p>
                <h3>{{ group.seriesName }}</h3>
              </div>
              <span class="tag">Serie #{{ group.seriesId }}</span>
            </div>
            <div class="measurement-meta">
              <span>Anzahl Messungen: {{ group.measurementCount }}</span>
              <span>Letzte Messung: #{{ group.latestMeasurementId }} ({{ group.latestTemplateName }})</span>
              <span>Autor*innen: {{ group.authorNames.join(', ') }}</span>
            </div>
            <div class="template-tags">
              <span *ngFor="let template of group.templateNames" class="tag tag-secondary">
                {{ template }}
              </span>
            </div>
          </article>
        </div>
      } @else {
        @if (!loading()) {
          <div class="empty-state">
            @if (hasActiveQuery()) {
              <p class="empty-title">Keine Treffer</p>
              <p class="empty-text">
                FÃ¼r â€{{ lastSearchTerm() }}â€œ wurden keine Messungen gefunden.
              </p>
            } @else {
              <p class="empty-title">Noch keine Messungen vorhanden</p>
              <p class="empty-text">
                Sobald Messdaten importiert oder erstellt werden, sehen Sie sie hier in der Ãœbersicht.
              </p>
            }
          </div>
        }
      }
    </section>
  </main>

  <app-footer />
</div>
